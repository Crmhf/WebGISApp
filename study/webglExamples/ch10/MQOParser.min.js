var MQODoc=function(){this.lines;this.index;this.materials;this.objects;this.numVertices;this.numIndices};MQODoc.prototype.parse=function(b){this.lines=b.split("\n");this.lines.push(null);this.index=0;this.materials=null;this.objects=new Array(0);this.numVertices=0;this.numIndices=0;var a;var c;while(a=this.lines[this.index++]){if(a.indexOf("Scene")>=0){this.skipToEndOfChunk();continue}if(a.indexOf("Material")>=0){this.materials=this.readMaterials(a);continue}if(a.indexOf("Object")>=0){if(c=this.readObjects()){this.objects.push(c)}else{return false}continue}}return true};MQODoc.prototype.readMaterials=function(o){var e=new StringParser(o);e.skipToNextWord();var f=e.getInt();var m=new Array(f);for(var h=0;h<f;h++){e.init(this.lines[this.index++]);e.skipToNextWord();var d=e.getWord();if(d=="col"){var c=e.getFloat();var j=e.getFloat();var k=e.getFloat();var l=e.getFloat();m[h]=new Material(c,j,k,l)}else{alert("error material");return null}}this.skipToEndOfChunk();return m};MQODoc.prototype.readObjects=function(){var e=new MQOObject();var b;while(b=this.lines[this.index++]){if(b.indexOf("facet")>=0){continue}if(b.indexOf("color_type")>=0){continue}if(b.indexOf("color")>=0){e.color=this.readColor(b);continue}if(b.indexOf("shading")>=0){e.shading=this.readShading(b);continue}if(b.indexOf("vertex")>=0){e.vertices=this.readVertices(b);continue}if(b.indexOf("face")>=0){e.faces=this.readFaces(b);continue}if(b.indexOf("}")>=0){break}}for(var c=0,a=e.faces.length;c<a;c++){var d=e.faces[c];d.setNormal(e.vertices)}return e};MQODoc.prototype.readColor=function(c){var f=new StringParser(c);f.skipToNextWord();var e=f.getFloat();var d=f.getFloat();var a=f.getFloat();return new Material(e,d,a,1)};MQODoc.prototype.readShading=function(a){var b=new StringParser(a);b.skipToNextWord();return b.getInt()};MQODoc.prototype.readVertices=function(b){var e=new StringParser(b);e.skipToNextWord();var h=e.getInt();var c=new Array(h);for(var d=0;d<h;d++){e.init(this.lines[this.index++]);var a=e.getFloat();var g=e.getFloat();var f=e.getFloat();c[d]=new Vertex(a,g,f)}this.skipToEndOfChunk();return c};MQODoc.prototype.readFaces=function(l){var b=new StringParser(l);b.skipToNextWord();var e=b.getInt();var d=new Array(e);for(var g=0;g<e;g++){b.init(this.lines[this.index++]);var c=b.getInt();if(c!=3&&c!=4){alert("error face");continue}var h=new Uint16Array(c);var k=-1;var a;while(a=b.getWord()){if(a=="V"){for(var f=0;f<c;f++){h[f]=b.getInt()}continue}if(a=="M"){k=b.getInt();break}}d[g]=new Face(h,k);this.updateNumVertices(c)}this.skipToEndOfChunk();return d};MQODoc.prototype.updateNumVertices=function(a){this.numVertices+=a;if(a==3){this.numIndices+=a}else{this.numIndices+=a*2}};MQODoc.prototype.skipToEndOfChunk=function(){var a;while(a=this.lines[this.index++]){if(a.indexOf("}")>=0){break}}};MQODoc.prototype.getDrawingInfo=function(){var c=new Float32Array(this.numVertices*3);var q=new Float32Array(this.numVertices*3);var f=new Float32Array(this.numVertices*4);var a=new Uint16Array(this.numIndices);var o=0,d=0,p=0;for(var w=0,x=this.objects.length;w<x;w++){var m=this.objects[w];for(var u=0,b=m.faces.length;u<b;u++){var e=m.faces[u];var h;if(this.materials!=null&&e.mIndex>=0){h=this.materials[e.mIndex]}else{h=m.color}for(var t=0,r=e.vIndices.length;t<r;t++){var g=m.vertices[e.vIndices[t]];var y;if(m.shading==0){y=e.normal}else{y=g.normal}for(var s=0;s<3;s++){c[o+t*3+s]=g.xyz[s];q[o+t*3+s]=y[s]}for(var s=0;s<4;s++){f[d+t*4+s]=h.color[s]}}for(var s=0;s<3;s++){a[p+s]=o/3+s}if(r==4){a[p+3]=o/3+0;a[p+4]=o/3+2;a[p+5]=o/3+3;p+=3}p+=3;o+=(r*3);d+=(r*4)}}return new DrawingInfo(c,q,f,a)};var Material=function(f,e,c,d){this.color=[f,e,c,d]};var MQOObject=function(){this.shading=1;this.color=null;this.vertices=null;this.faces=null};var Vertex=function(a,c,b){this.xyz=[a,c,b];this.normal=[0,0,0]};var Face=function(b,a){this.vIndices=b;this.mIndex=a;this.normal=null};Face.prototype.setNormal=function(d){var b=d[this.vIndices[0]];var h=d[this.vIndices[1]];var g=d[this.vIndices[2]];this.normal=calcNormal(b.xyz,h.xyz,g.xyz);if(this.normal==null){if(this.vIndices.length==4){var f=d[this.vIndices[3]];this.normal=calcNormal(h.xyz,g.xyz,f.xyz)}if(this.normal==null){this.normal=[0,1,0]}}for(var e=0,a=this.vIndices.length;e<a;e++){var c=d[this.vIndices[e]];c.normal[0]+=this.normal[0];c.normal[1]+=this.normal[1];c.normal[2]+=this.normal[2]}};var DrawingInfo=function(b,c,a,d){this.vertices=b;this.normals=c;this.colors=a;this.indices=d};var StringParser=function(a){this.str;this.index;this.init(a)};StringParser.prototype.init=function(a){this.str=a;this.index=0};StringParser.prototype.skipDelimiters=function(){for(var b=this.index,a=this.str.length;b<a;b++){var d=this.str.charAt(b);if(d=="\t"||d==" "||d=="("||d==")"||d=='"'){continue}break}this.index=b};StringParser.prototype.skipToNextWord=function(){this.skipDelimiters();var a=getWordLength(this.str,this.index);this.index+=(a+1)};StringParser.prototype.getWord=function(){this.skipDelimiters();var b=getWordLength(this.str,this.index);if(b==0){return null}var a=this.str.substr(this.index,b);this.index+=(b+1);return a};StringParser.prototype.getInt=function(){return parseInt(this.getWord())};StringParser.prototype.getFloat=function(){return parseFloat(this.getWord())};function getWordLength(d,g){var f=0;for(var b=g,a=d.length;b<a;b++){var e=d.charAt(b);if(e=="\t"||e==" "||e=="("||e==")"||e=='"'){break}}return b-g}function calcNormal(j,f,e){var a=new Float32Array(3);var h=new Float32Array(3);for(var d=0;d<3;d++){a[d]=j[d]-f[d];h[d]=e[d]-f[d]}var g=new Float32Array(3);g[0]=a[1]*h[2]-a[2]*h[1];g[1]=a[2]*h[0]-a[0]*h[2];g[2]=a[0]*h[1]-a[1]*h[0];var b=new Vector3(g);b.normalize();return b.elements};