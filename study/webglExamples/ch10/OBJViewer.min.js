var VSHADER_SOURCE="attribute vec4 a_Position;\nattribute vec4 a_Color;\nattribute vec4 a_Normal;\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_NormalMatrix;\nvarying vec4 v_Color;\nvoid main() {\n  vec3 lightDirection = vec3(-0.35, 0.35, 0.87);\n  gl_Position = u_MvpMatrix * a_Position;\n  vec3 normal = normalize(vec3(u_NormalMatrix * a_Normal));\n  float nDotL = max(dot(normal, lightDirection), 0.0);\n  v_Color = vec4(a_Color.rgb * nDotL, a_Color.a);\n}\n";var FSHADER_SOURCE="#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec4 v_Color;\nvoid main() {\n  gl_FragColor = v_Color;\n}\n";function main(){var c=document.getElementById("webgl");var g=getWebGLContext(c);if(!g){console.log("Failed to get the rendering context for WebGL");return}if(!initShaders(g,VSHADER_SOURCE,FSHADER_SOURCE)){console.log("Failed to intialize shaders.");return}g.clearColor(0.2,0.2,0.2,1);g.enable(g.DEPTH_TEST);var a=g.program;a.a_Position=g.getAttribLocation(a,"a_Position");a.a_Normal=g.getAttribLocation(a,"a_Normal");a.a_Color=g.getAttribLocation(a,"a_Color");a.u_MvpMatrix=g.getUniformLocation(a,"u_MvpMatrix");a.u_NormalMatrix=g.getUniformLocation(a,"u_NormalMatrix");if(a.a_Position<0||a.a_Normal<0||a.a_Color<0||!a.u_MvpMatrix||!a.u_NormalMatrix){console.log("attribute, uniform変数の格納場所の取得に失敗");return}var b=initVertexBuffers(g,a);if(!b){console.log("Failed to set the vertex information");return}var e=new Matrix4();e.setPerspective(30,c.width/c.height,1,5000);e.lookAt(0,500,200,0,0,0,0,1,0);readOBJFile("cube.obj",g,b,60,true);var f=0;var d=function(){f=animate(f);draw(g,g.program,f,e,b);requestAnimationFrame(d,c)};d()}function initVertexBuffers(c,a){var b=new Object();b.vertexBuffer=createEmptyArrayBuffer(c,a.a_Position,3,c.FLOAT);b.normalBuffer=createEmptyArrayBuffer(c,a.a_Normal,3,c.FLOAT);b.colorBuffer=createEmptyArrayBuffer(c,a.a_Color,4,c.FLOAT);b.indexBuffer=c.createBuffer();if(!b.vertexBuffer||!b.normalBuffer||!b.colorBuffer||!b.indexBuffer){return null}c.bindBuffer(c.ARRAY_BUFFER,null);return b}function createEmptyArrayBuffer(d,e,b,c){var a=d.createBuffer();if(!a){console.log("Failed to create the buffer object");return null}d.bindBuffer(d.ARRAY_BUFFER,a);d.vertexAttribPointer(e,b,c,false,0,0);d.enableVertexAttribArray(e);return a}function readOBJFile(f,e,b,d,a){var c=new XMLHttpRequest();c.onreadystatechange=function(){if(c.readyState===4&&c.status!==404){onReadOBJFile(c.responseText,f,e,b,d,a)}};c.open("GET",f,true);c.send()}var g_objDoc=null;var g_drawingInfo=null;function onReadOBJFile(d,h,g,f,e,c){var b=new OBJDoc(h);var a=b.parse(d,e,c);if(!a){g_objDoc=null;g_drawingInfo=null;console.log("OBJ file parsing error.");return}g_objDoc=b}var g_modelMatrix=new Matrix4();var g_mvpMatrix=new Matrix4();var g_normalMatrix=new Matrix4();function draw(e,a,d,c,b){if(g_objDoc!=null&&g_objDoc.isMTLComplete()){g_drawingInfo=onReadComplete(e,b,g_objDoc);g_objDoc=null}if(!g_drawingInfo){return}e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);g_modelMatrix.setRotate(d,1,0,0);g_modelMatrix.rotate(d,0,1,0);g_modelMatrix.rotate(d,0,0,1);g_normalMatrix.setInverseOf(g_modelMatrix);g_normalMatrix.transpose();e.uniformMatrix4fv(a.u_NormalMatrix,false,g_normalMatrix.elements);g_mvpMatrix.set(c);g_mvpMatrix.multiply(g_modelMatrix);e.uniformMatrix4fv(a.u_MvpMatrix,false,g_mvpMatrix.elements);e.drawElements(e.TRIANGLES,g_drawingInfo.indices.length,e.UNSIGNED_SHORT,0)}function onReadComplete(d,b,a){var c=a.getDrawingInfo();d.bindBuffer(d.ARRAY_BUFFER,b.vertexBuffer);d.bufferData(d.ARRAY_BUFFER,c.vertices,d.STATIC_DRAW);d.bindBuffer(d.ARRAY_BUFFER,b.normalBuffer);d.bufferData(d.ARRAY_BUFFER,c.normals,d.STATIC_DRAW);d.bindBuffer(d.ARRAY_BUFFER,b.colorBuffer);d.bufferData(d.ARRAY_BUFFER,c.colors,d.STATIC_DRAW);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,b.indexBuffer);d.bufferData(d.ELEMENT_ARRAY_BUFFER,c.indices,d.STATIC_DRAW);return c}var ANGLE_STEP=30;var last=Date.now();function animate(c){var b=Date.now();var a=b-last;last=b;var d=c+(ANGLE_STEP*a)/1000;return d%360}var OBJDoc=function(a){this.fileName=a;this.mtls=new Array(0);this.objects=new Array(0);this.vertices=new Array(0);this.normals=new Array(0)};OBJDoc.prototype.parse=function(f,c,k){var p=f.split("\n");p.push(null);var i=0;var n=null;var b="";var q;var a=new StringParser();while((q=p[i++])!=null){a.init(q);var e=a.getWord();if(e==null){continue}switch(e){case"#":continue;case"mtllib":var o=this.parseMtllib(a,this.fileName);var m=new MTLDoc();this.mtls.push(m);var g=new XMLHttpRequest();g.onreadystatechange=function(){if(g.readyState==4){if(g.status!=404){onReadMTLFile(g.responseText,m)}else{m.complete=true}}};g.open("GET",o,true);g.send();continue;case"o":case"g":var d=this.parseObjectName(a);this.objects.push(d);n=d;continue;case"v":var h=this.parseVertex(a,c);this.vertices.push(h);continue;case"vn":var j=this.parseNormal(a);this.normals.push(j);continue;case"usemtl":b=this.parseUsemtl(a);continue;case"f":var l=this.parseFace(a,b,this.vertices,k);n.addFace(l);continue}}return true};OBJDoc.prototype.parseMtllib=function(b,d){var a=d.lastIndexOf("/");var c="";if(a>0){c=d.substr(0,a+1)}return c+b.getWord()};OBJDoc.prototype.parseObjectName=function(b){var a=b.getWord();return(new OBJObject(a))};OBJDoc.prototype.parseVertex=function(b,d){var a=b.getFloat()*d;var e=b.getFloat()*d;var c=b.getFloat()*d;return(new Vertex(a,e,c))};OBJDoc.prototype.parseNormal=function(b){var a=b.getFloat();var d=b.getFloat();var c=b.getFloat();return(new Normal(a,d,c))};OBJDoc.prototype.parseUsemtl=function(a){return a.getWord()};OBJDoc.prototype.parseFace=function(o,p,g,j){var h=new Face(p);for(;;){var q=o.getWord();if(q==null){break}var e=q.split("/");if(e.length>=1){var s=parseInt(e[0])-1;h.vIndices.push(s)}if(e.length>=3){var f=parseInt(e[2])-1;h.nIndices.push(f)}else{h.nIndices.push(-1)}}var d=[g[h.vIndices[0]].x,g[h.vIndices[0]].y,g[h.vIndices[0]].z];var c=[g[h.vIndices[1]].x,g[h.vIndices[1]].y,g[h.vIndices[1]].z];var b=[g[h.vIndices[2]].x,g[h.vIndices[2]].y,g[h.vIndices[2]].z];var t=calcNormal(d,c,b);if(t==null){if(h.vIndices.length>=4){var a=[g[h.vIndices[3]].x,g[h.vIndices[3]].y,g[h.vIndices[3]].z];t=calcNormal(c,b,a)}if(t==null){t=[0,1,0]}}if(j){t[0]=-t[0];t[1]=-t[1];t[2]=-t[2]}h.normal=new Normal(t[0],t[1],t[2]);if(h.vIndices.length>3){var l=h.vIndices.length-2;var k=new Array(l*3);var r=new Array(l*3);for(var m=0;m<l;m++){k[m*3+0]=h.vIndices[0];k[m*3+1]=h.vIndices[m+1];k[m*3+2]=h.vIndices[m+2];r[m*3+0]=h.nIndices[0];r[m*3+1]=h.nIndices[m+1];r[m*3+2]=h.nIndices[m+2]}h.vIndices=k;h.nIndices=r}h.numIndices=h.vIndices.length;return h};function onReadMTLFile(d,g){var h=d.split("\n");h.push(null);var e=0;var i;var a="";var b=new StringParser();while((i=h[e++])!=null){b.init(i);var c=b.getWord();if(c==null){continue}switch(c){case"#":continue;case"newmtl":a=g.parseNewmtl(b);continue;case"Kd":if(a==""){continue}var f=g.parseRGB(b,a);g.materials.push(f);a="";continue}}g.complete=true}OBJDoc.prototype.isMTLComplete=function(){if(this.mtls.length==0){return true}for(var a=0;a<this.mtls.length;a++){if(!this.mtls[a].complete){return false}}return true};OBJDoc.prototype.findColor=function(b){for(var c=0;c<this.mtls.length;c++){for(var a=0;a<this.mtls[c].materials.length;a++){if(this.mtls[c].materials[a].name==b){return(this.mtls[c].materials[a].color)}}}return(new Color(0.8,0.8,0.8,1))};OBJDoc.prototype.getDrawingInfo=function(){var h=0;for(var r=0;r<this.objects.length;r++){h+=this.objects[r].numIndices}var p=h;var c=new Float32Array(p*3);var l=new Float32Array(p*3);var e=new Float32Array(p*4);var b=new Uint16Array(h);var g=0;for(var r=0;r<this.objects.length;r++){var u=this.objects[r];for(var q=0;q<u.faces.length;q++){var d=u.faces[q];var n=this.findColor(d.materialName);var m=d.normal;for(var o=0;o<d.vIndices.length;o++){b[g]=g;var f=d.vIndices[o];var s=this.vertices[f];c[g*3+0]=s.x;c[g*3+1]=s.y;c[g*3+2]=s.z;e[g*4+0]=n.r;e[g*4+1]=n.g;e[g*4+2]=n.b;e[g*4+3]=n.a;var a=d.nIndices[o];if(a>=0){var t=this.normals[a];l[g*3+0]=t.x;l[g*3+1]=t.y;l[g*3+2]=t.z}else{l[g*3+0]=m.x;l[g*3+1]=m.y;l[g*3+2]=m.z}g++}}}return new DrawingInfo(c,l,e,b)};var MTLDoc=function(){this.complete=false;this.materials=new Array(0)};MTLDoc.prototype.parseNewmtl=function(a){return a.getWord()};MTLDoc.prototype.parseRGB=function(f,c){var e=f.getFloat();var d=f.getFloat();var a=f.getFloat();return(new Material(c,e,d,a,1))};var Material=function(e,h,f,c,d){this.name=e;this.color=new Color(h,f,c,d)};var Vertex=function(a,c,b){this.x=a;this.y=c;this.z=b};var Normal=function(a,c,b){this.x=a;this.y=c;this.z=b};var Color=function(f,e,c,d){this.r=f;this.g=e;this.b=c;this.a=d};var OBJObject=function(a){this.name=a;this.faces=new Array(0);this.numIndices=0};OBJObject.prototype.addFace=function(a){this.faces.push(a);this.numIndices+=a.numIndices};var Face=function(a){this.materialName=a;if(a==null){this.materialName=""}this.vIndices=new Array(0);this.nIndices=new Array(0)};var DrawingInfo=function(b,c,a,d){this.vertices=b;this.normals=c;this.colors=a;this.indices=d};var StringParser=function(a){this.str;this.index;this.init(a)};StringParser.prototype.init=function(a){this.str=a;this.index=0};StringParser.prototype.skipDelimiters=function(){for(var b=this.index,a=this.str.length;b<a;b++){var d=this.str.charAt(b);if(d=="\t"||d==" "||d=="("||d==")"||d=='"'){continue}break}this.index=b};StringParser.prototype.skipToNextWord=function(){this.skipDelimiters();var a=getWordLength(this.str,this.index);this.index+=(a+1)};StringParser.prototype.getWord=function(){this.skipDelimiters();var b=getWordLength(this.str,this.index);if(b==0){return null}var a=this.str.substr(this.index,b);this.index+=(b+1);return a};StringParser.prototype.getInt=function(){return parseInt(this.getWord())};StringParser.prototype.getFloat=function(){return parseFloat(this.getWord())};function getWordLength(d,g){var f=0;for(var b=g,a=d.length;b<a;b++){var e=d.charAt(b);if(e=="\t"||e==" "||e=="("||e==")"||e=='"'){break}}return b-g}function calcNormal(j,f,e){var a=new Float32Array(3);var h=new Float32Array(3);for(var d=0;d<3;d++){a[d]=j[d]-f[d];h[d]=e[d]-f[d]}var g=new Float32Array(3);g[0]=a[1]*h[2]-a[2]*h[1];g[1]=a[2]*h[0]-a[0]*h[2];g[2]=a[0]*h[1]-a[1]*h[0];var b=new Vector3(g);b.normalize();return b.elements};