var SHADOW_VSHADER_SOURCE="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvoid main() {\n  gl_Position = u_MvpMatrix * a_Position;\n}\n";var SHADOW_FSHADER_SOURCE="#ifdef GL_ES\nprecision mediump float;\n#endif\nvoid main() {\n  const vec4 bitShift = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);\n  const vec4 bitMask = vec4(1.0/256.0, 1.0/256.0, 1.0/256.0, 0.0);\n  vec4 rgbaDepth = fract(gl_FragCoord.z * bitShift);\n  rgbaDepth -= rgbaDepth.gbaa * bitMask;\n  gl_FragColor = rgbaDepth;\n}\n";var VSHADER_SOURCE="attribute vec4 a_Position;\nattribute vec4 a_Color;\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_MvpMatrixFromLight;\nvarying vec4 v_PositionFromLight;\nvarying vec4 v_Color;\nvoid main() {\n  gl_Position = u_MvpMatrix * a_Position;\n  v_PositionFromLight = u_MvpMatrixFromLight * a_Position;\n  v_Color = a_Color;\n}\n";var FSHADER_SOURCE="#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D u_ShadowMap;\nvarying vec4 v_PositionFromLight;\nvarying vec4 v_Color;\nfloat unpackDepth(const in vec4 rgbaDepth) {\n  const vec4 bitShift = vec4(1.0, 1.0/256.0, 1.0/(256.0*256.0), 1.0/(256.0*256.0*256.0));\n  float depth = dot(rgbaDepth, bitShift);\n  return depth;\n}\nvoid main() {\n  vec3 shadowCoord = (v_PositionFromLight.xyz/v_PositionFromLight.w)/2.0 + 0.5;\n  vec4 rgbaDepth = texture2D(u_ShadowMap, shadowCoord.xy);\n  float depth = unpackDepth(rgbaDepth);\n  float visibility = (shadowCoord.z > depth + 0.0015) ? 0.7 : 1.0;\n  gl_FragColor = vec4(v_Color.rgb * visibility, v_Color.a);\n}\n";var OFFSCREEN_WIDTH=2048,OFFSCREEN_HEIGHT=2048;var LIGHT_X=0,LIGHT_Y=40,LIGHT_Z=2;function main(){var b=document.getElementById("webgl");var h=getWebGLContext(b);if(!h){console.log("Failed to get the rendering context for WebGL");return}var l=createProgram(h,SHADOW_VSHADER_SOURCE,SHADOW_FSHADER_SOURCE);l.a_Position=h.getAttribLocation(l,"a_Position");l.u_MvpMatrix=h.getUniformLocation(l,"u_MvpMatrix");if(l.a_Position<0||!l.u_MvpMatrix){console.log("Failed to get the storage location of attribute or uniform variable from shadowProgram");return}var j=createProgram(h,VSHADER_SOURCE,FSHADER_SOURCE);j.a_Position=h.getAttribLocation(j,"a_Position");j.a_Color=h.getAttribLocation(j,"a_Color");j.u_MvpMatrix=h.getUniformLocation(j,"u_MvpMatrix");j.u_MvpMatrixFromLight=h.getUniformLocation(j,"u_MvpMatrixFromLight");j.u_ShadowMap=h.getUniformLocation(j,"u_ShadowMap");if(j.a_Position<0||j.a_Color<0||!j.u_MvpMatrix||!j.u_MvpMatrixFromLight||!j.u_ShadowMap){console.log("Failed to get the storage location of attribute or uniform variable from normalProgram");return}var i=initVertexBuffersForTriangle(h);var k=initVertexBuffersForPlane(h);if(!i||!k){console.log("Failed to set the vertex information");return}var d=initFramebufferObject(h);if(!d){console.log("Failed to initialize frame buffer object");return}h.activeTexture(h.TEXTURE0);h.bindTexture(h.TEXTURE_2D,d.texture);h.clearColor(0,0,0,1);h.enable(h.DEPTH_TEST);var f=new Matrix4();f.setPerspective(70,OFFSCREEN_WIDTH/OFFSCREEN_HEIGHT,1,200);f.lookAt(LIGHT_X,LIGHT_Y,LIGHT_Z,0,0,0,0,1,0);var m=new Matrix4();m.setPerspective(45,b.width/b.height,1,100);m.lookAt(0,7,9,0,0,0,0,1,0);var e=0;var a=new Matrix4();var c=new Matrix4();var g=function(){e=animate(e);h.bindFramebuffer(h.FRAMEBUFFER,d);h.viewport(0,0,OFFSCREEN_HEIGHT,OFFSCREEN_HEIGHT);h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT);h.useProgram(l);drawTriangle(h,l,i,e,f);a.set(g_mvpMatrix);drawPlane(h,l,k,f);c.set(g_mvpMatrix);h.bindFramebuffer(h.FRAMEBUFFER,null);h.viewport(0,0,b.width,b.height);h.clear(h.COLOR_BUFFER_BIT|h.DEPTH_BUFFER_BIT);h.useProgram(j);h.uniform1i(j.u_ShadowMap,0);h.uniformMatrix4fv(j.u_MvpMatrixFromLight,false,a.elements);drawTriangle(h,j,i,e,m);h.uniformMatrix4fv(j.u_MvpMatrixFromLight,false,c.elements);drawPlane(h,j,k,m);window.requestAnimationFrame(g,b)};g()}var g_modelMatrix=new Matrix4();var g_mvpMatrix=new Matrix4();function drawTriangle(e,a,c,d,b){g_modelMatrix.setRotate(d,0,1,0);draw(e,a,c,b)}function drawPlane(d,b,a,c){g_modelMatrix.setRotate(-45,0,1,1);draw(d,b,a,c)}function draw(d,a,c,b){initAttributeVariable(d,a.a_Position,c.vertexBuffer);if(a.a_Color!=undefined){initAttributeVariable(d,a.a_Color,c.colorBuffer)}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,c.indexBuffer);g_mvpMatrix.set(b);g_mvpMatrix.multiply(g_modelMatrix);d.uniformMatrix4fv(a.u_MvpMatrix,false,g_mvpMatrix.elements);d.drawElements(d.TRIANGLES,c.numIndices,d.UNSIGNED_BYTE,0)}function initAttributeVariable(b,c,a){b.bindBuffer(b.ARRAY_BUFFER,a);b.vertexAttribPointer(c,a.num,a.type,false,0,0);b.enableVertexAttribArray(c)}function initVertexBuffersForPlane(e){var b=new Float32Array([3,-1.7,2.5,-3,-1.7,2.5,-3,-1.7,-2.5,3,-1.7,-2.5]);var a=new Float32Array([1,1,1,1,1,1,1,1,1,1,1,1]);var d=new Uint8Array([0,1,2,0,2,3]);var c=new Object();c.vertexBuffer=initArrayBufferForLaterUse(e,b,3,e.FLOAT);c.colorBuffer=initArrayBufferForLaterUse(e,a,3,e.FLOAT);c.indexBuffer=initElementArrayBufferForLaterUse(e,d,e.UNSIGNED_BYTE);if(!c.vertexBuffer||!c.colorBuffer||!c.indexBuffer){return null}c.numIndices=d.length;e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c}function initVertexBuffersForTriangle(e){var b=new Float32Array([-0.8,3.5,0,0.8,3.5,0,0,3.5,1.8]);var a=new Float32Array([1,0.5,0,1,0.5,0,1,0,0]);var d=new Uint8Array([0,1,2]);var c=new Object();c.vertexBuffer=initArrayBufferForLaterUse(e,b,3,e.FLOAT);c.colorBuffer=initArrayBufferForLaterUse(e,a,3,e.FLOAT);c.indexBuffer=initElementArrayBufferForLaterUse(e,d,e.UNSIGNED_BYTE);if(!c.vertexBuffer||!c.colorBuffer||!c.indexBuffer){return null}c.numIndices=d.length;e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c}function initArrayBufferForLaterUse(e,d,b,c){var a=e.createBuffer();if(!a){console.log("Failed to create the buffer object");return null}e.bindBuffer(e.ARRAY_BUFFER,a);e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW);a.num=b;a.type=c;return a}function initElementArrayBufferForLaterUse(d,c,b){var a=d.createBuffer();if(!a){console.log("Failed to create the buffer object");return null}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a);d.bufferData(d.ELEMENT_ARRAY_BUFFER,c,d.STATIC_DRAW);a.type=b;return a}function initFramebufferObject(g){var d,c,b;var a=function(){if(d){g.deleteFramebuffer(d)}if(c){g.deleteTexture(c)}if(b){g.deleteRenderbuffer(b)}return null};d=g.createFramebuffer();if(!d){console.log("Failed to create frame buffer object");return a()}c=g.createTexture();if(!c){console.log("Failed to create texture object");return a()}g.bindTexture(g.TEXTURE_2D,c);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,OFFSCREEN_WIDTH,OFFSCREEN_HEIGHT,0,g.RGBA,g.UNSIGNED_BYTE,null);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.NEAREST);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,g.NEAREST);b=g.createRenderbuffer();if(!b){console.log("Failed to create renderbuffer object");return a()}g.bindRenderbuffer(g.RENDERBUFFER,b);g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_COMPONENT16,OFFSCREEN_WIDTH,OFFSCREEN_HEIGHT);g.bindFramebuffer(g.FRAMEBUFFER,d);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,c,0);g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,b);var f=g.checkFramebufferStatus(g.FRAMEBUFFER);if(g.FRAMEBUFFER_COMPLETE!==f){console.log("Frame buffer object is incomplete: "+f.toString());return a()}d.texture=c;g.bindFramebuffer(g.FRAMEBUFFER,null);g.bindTexture(g.TEXTURE_2D,null);g.bindRenderbuffer(g.RENDERBUFFER,null);return d}var ANGLE_STEP=40;var last=Date.now();function animate(c){var b=Date.now();var a=b-last;last=b;var d=c+(ANGLE_STEP*a)/1000;return d%360};