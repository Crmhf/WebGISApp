var VSHADER_SOURCE="attribute vec4 a_Position;\nattribute vec2 a_TexCoord;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_TexCoord;\nvoid main() {\n  gl_Position = u_MvpMatrix * a_Position;\n  v_TexCoord = a_TexCoord;\n}\n";var FSHADER_SOURCE="#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D u_Sampler;\nvarying vec2 v_TexCoord;\nvoid main() {\n  gl_FragColor = texture2D(u_Sampler, v_TexCoord);\n}\n";var OFFSCREEN_WIDTH=256;var OFFSCREEN_HEIGHT=256;function main(){var b=document.getElementById("webgl");var h=getWebGLContext(b);if(!h){console.log("Failed to get the rendering context for WebGL");return}if(!initShaders(h,VSHADER_SOURCE,FSHADER_SOURCE)){console.log("Failed to intialize shaders.");return}var e=h.program;e.a_Position=h.getAttribLocation(e,"a_Position");e.a_TexCoord=h.getAttribLocation(e,"a_TexCoord");e.u_MvpMatrix=h.getUniformLocation(e,"u_MvpMatrix");if(e.a_Position<0||e.a_TexCoord<0||!e.u_MvpMatrix){console.log("Failed to get the storage location of a_Position, a_TexCoord, u_MvpMatrix");return}var a=initVertexBuffersForCube(h);var i=initVertexBuffersForPlane(h);if(!a||!i){console.log("Failed to set the vertex information");return}var j=initTextures(h);if(!j){console.log("Failed to intialize the texture.");return}var c=initFramebufferObject(h);if(!c){console.log("Failed to intialize the framebuffer object (FBO)");return}h.enable(h.DEPTH_TEST);var k=new Matrix4();k.setPerspective(30,b.width/b.height,1,100);k.lookAt(0,0,7,0,0,0,0,1,0);var g=new Matrix4();g.setPerspective(30,OFFSCREEN_WIDTH/OFFSCREEN_HEIGHT,1,100);g.lookAt(0,2,7,0,0,0,0,1,0);var d=0;var f=function(){d=animate(d);draw(h,b,c,i,a,d,j,k,g);window.requestAnimationFrame(f,b)};f()}function initVertexBuffersForCube(e){var a=new Float32Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1]);var b=new Float32Array([1,1,0,1,0,0,1,0,0,1,0,0,1,0,1,1,1,0,1,1,0,1,0,0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1]);var d=new Uint8Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]);var c=new Object();c.vertexBuffer=initArrayBufferForLaterUse(e,a,3,e.FLOAT);c.texCoordBuffer=initArrayBufferForLaterUse(e,b,2,e.FLOAT);c.indexBuffer=initElementArrayBufferForLaterUse(e,d,e.UNSIGNED_BYTE);if(!c.vertexBuffer||!c.texCoordBuffer||!c.indexBuffer){return null}c.numIndices=d.length;e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c}function initVertexBuffersForPlane(e){var a=new Float32Array([1,1,0,-1,1,0,-1,-1,0,1,-1,0]);var b=new Float32Array([1,1,0,1,0,0,1,0]);var d=new Uint8Array([0,1,2,0,2,3]);var c=new Object();c.vertexBuffer=initArrayBufferForLaterUse(e,a,3,e.FLOAT);c.texCoordBuffer=initArrayBufferForLaterUse(e,b,2,e.FLOAT);c.indexBuffer=initElementArrayBufferForLaterUse(e,d,e.UNSIGNED_BYTE);if(!c.vertexBuffer||!c.texCoordBuffer||!c.indexBuffer){return null}c.numIndices=d.length;e.bindBuffer(e.ARRAY_BUFFER,null);e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null);return c}function initArrayBufferForLaterUse(e,d,b,c){var a=e.createBuffer();if(!a){console.log("Failed to create the buffer object");return null}e.bindBuffer(e.ARRAY_BUFFER,a);e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW);a.num=b;a.type=c;return a}function initElementArrayBufferForLaterUse(d,c,b){var a=d.createBuffer();if(!a){console.log("Failed to create the buffer object");return null}d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,a);d.bufferData(d.ELEMENT_ARRAY_BUFFER,c,d.STATIC_DRAW);a.type=b;return a}function initTextures(d){var a=d.createTexture();if(!a){console.log("Failed to create the Texture object");return null}var c=d.getUniformLocation(d.program,"u_Sampler");if(!c){console.log("Failed to get the storage location of u_Sampler");return null}var b=new Image();if(!b){console.log("Failed to create the Image object");return null}b.onload=function(){d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,1);d.bindTexture(d.TEXTURE_2D,a);d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR);d.texImage2D(d.TEXTURE_2D,0,d.RGBA,d.RGBA,d.UNSIGNED_BYTE,b);d.uniform1i(c,0);d.bindTexture(d.TEXTURE_2D,null)};b.src="../resources/sky_cloud.jpg";return a}function initFramebufferObject(g){var d,c,b;var a=function(){if(d){g.deleteFramebuffer(d)}if(c){g.deleteTexture(c)}if(b){g.deleteRenderbuffer(b)}return null};d=g.createFramebuffer();if(!d){console.log("Failed to create frame buffer object");return a()}c=g.createTexture();if(!c){console.log("Failed to create texture object");return a()}g.bindTexture(g.TEXTURE_2D,c);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,OFFSCREEN_WIDTH,OFFSCREEN_HEIGHT,0,g.RGBA,g.UNSIGNED_BYTE,null);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR);d.texture=c;b=g.createRenderbuffer();if(!b){console.log("Failed to create renderbuffer object");return a()}g.bindRenderbuffer(g.RENDERBUFFER,b);g.renderbufferStorage(g.RENDERBUFFER,g.DEPTH_COMPONENT16,OFFSCREEN_WIDTH,OFFSCREEN_HEIGHT);g.bindFramebuffer(g.FRAMEBUFFER,d);g.framebufferTexture2D(g.FRAMEBUFFER,g.COLOR_ATTACHMENT0,g.TEXTURE_2D,c,0);g.framebufferRenderbuffer(g.FRAMEBUFFER,g.DEPTH_ATTACHMENT,g.RENDERBUFFER,b);var f=g.checkFramebufferStatus(g.FRAMEBUFFER);if(g.FRAMEBUFFER_COMPLETE!==f){console.log("Frame buffer object is incomplete: "+f.toString());return a()}g.bindFramebuffer(g.FRAMEBUFFER,null);g.bindTexture(g.TEXTURE_2D,null);g.bindRenderbuffer(g.RENDERBUFFER,null);return d}function draw(f,b,c,g,a,d,h,i,e){f.bindFramebuffer(f.FRAMEBUFFER,c);f.viewport(0,0,OFFSCREEN_WIDTH,OFFSCREEN_HEIGHT);f.clearColor(0.2,0.2,0.4,1);f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);drawTexturedCube(f,f.program,a,d,h,e);f.bindFramebuffer(f.FRAMEBUFFER,null);f.viewport(0,0,b.width,b.height);f.clearColor(0,0,0,1);f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);drawTexturedPlane(f,f.program,g,d,c.texture,i)}var g_modelMatrix=new Matrix4();var g_mvpMatrix=new Matrix4();function drawTexturedCube(f,a,e,d,c,b){g_modelMatrix.setRotate(20,1,0,0);g_modelMatrix.rotate(d,0,1,0);g_mvpMatrix.set(b);g_mvpMatrix.multiply(g_modelMatrix);f.uniformMatrix4fv(a.u_MvpMatrix,false,g_mvpMatrix.elements);drawTexturedObject(f,a,e,c)}function drawTexturedPlane(f,a,e,d,c,b){g_modelMatrix.setTranslate(0,0,1);g_modelMatrix.rotate(20,1,0,0);g_modelMatrix.rotate(d,0,1,0);g_mvpMatrix.set(b);g_mvpMatrix.multiply(g_modelMatrix);f.uniformMatrix4fv(a.u_MvpMatrix,false,g_mvpMatrix.elements);drawTexturedObject(f,a,e,c)}function drawTexturedObject(d,a,c,b){initAttributeVariable(d,a.a_Position,c.vertexBuffer);initAttributeVariable(d,a.a_TexCoord,c.texCoordBuffer);d.activeTexture(d.TEXTURE0);d.bindTexture(d.TEXTURE_2D,b);d.bindBuffer(d.ELEMENT_ARRAY_BUFFER,c.indexBuffer);d.drawElements(d.TRIANGLES,c.numIndices,c.indexBuffer.type,0)}function initAttributeVariable(b,c,a){b.bindBuffer(b.ARRAY_BUFFER,a);b.vertexAttribPointer(c,a.num,a.type,false,0,0);b.enableVertexAttribArray(c)}function drawTexturedCube2(f,e,d,c,b,a){g_modelMatrix.rotate(20,1,0,0);g_modelMatrix.rotate(d,0,1,0);g_modelMatrix.scale(1,1,1);g_mvpMatrix.set(vpMatrix);g_mvpMatrix.multiply(g_modelMatrix);f.uniformMatrix4fv(a,false,g_mvpMatrix.elements);drawTexturedObject(f,e,c)}var ANGLE_STEP=30;var last=Date.now();function animate(c){var b=Date.now();var a=b-last;last=b;var d=c+(ANGLE_STEP*a)/1000;return d%360};