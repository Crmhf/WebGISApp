var VSHADER_SOURCE="uniform mat4 u_perspectiveMatrix;\nuniform mat4 u_modelMatrix;\nuniform mat4 u_viewMatrix;\nuniform vec3 u_lightDir;\n\nattribute vec4 a_Position;\nattribute vec2 a_TexCoord;\n\nvarying vec4 v_Color;\nvarying vec2 v_TexCoord;\n\nvoid main() {\n  mat4 modelViewMatrix = u_viewMatrix * u_modelMatrix;\n  gl_Position = u_perspectiveMatrix * modelViewMatrix * a_Position;\n\n  v_TexCoord = a_TexCoord;\n}\n";var FSHADER_SOURCE="#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D u_Sampler;\nuniform float u_Alpha;\nvarying vec2 v_TexCoord;\nvoid main() {\n  gl_FragColor.rgb = texture2D(u_Sampler, vec2(v_TexCoord.s, v_TexCoord.t)).rgb;\n  gl_FragColor.a = u_Alpha;\n}\n";var g_perspectiveMatrix=new Matrix4();var g_lightDir=new Vector3([0,0.4,0.6]);var g_modelMatrix=new Matrix4();var g_viewMatrix=new Matrix4();var g_quadVertexPositionBuffer;var g_quadVertexIndexBuffer;var g_quadVertexTexCoordBuffer;var TEXTURE;var IMAGE;function main(){var a=document.getElementById("webgl");var e=getWebGLContext(a);if(!e){console.log("Failed to get the rendering context for WebGL");return}if(!initShaders(e,VSHADER_SOURCE,FSHADER_SOURCE)){console.log("Failed to intialize shaders.");return}if(!initTextures(e,"../resources/particle.png")){console.log("Failed to set texture");return}var k=e.getUniformLocation(e.program,"u_perspectiveMatrix");var b=e.getUniformLocation(e.program,"u_modelMatrix");var l=e.getUniformLocation(e.program,"u_viewMatrix");var f=e.getUniformLocation(e.program,"u_lightDir");var j=e.getUniformLocation(e.program,"u_Sampler");var h=e.getUniformLocation(e.program,"u_Alpha");init_gl(e);sendQuadVertexBuffers(e);var g=new Array(500);for(var c=0;c<g.length;++c){g[c]=new Particle();initParticle(g[c],true)}var d=function(){window.requestAnimationFrame(d);updateParticle(g);drawCommon(e,a,k,l,f);drawParticle(e,g,k,b,j,h)};d()}function init_gl(a){a.enable(a.DEPTH_TEST);a.depthMask(false);a.clearColor(0,0,0,1);a.enable(a.BLEND);a.blendEquation(a.FUNC_ADD);a.blendFunc(a.SRC_ALPHA,a.ONE)}function drawCommon(e,c,b,a,d){e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);g_perspectiveMatrix.setPerspective(30,c.width/c.height,1,10000);g_viewMatrix.setLookAt(0,3,10,0,2,0,0,1,0);e.uniformMatrix4fv(b,false,g_perspectiveMatrix.elements);e.uniformMatrix4fv(a,false,g_viewMatrix.elements);e.uniform3fv(d,g_lightDir.elements)}function drawParticle(f,a,j,c,h,g){f.bindBuffer(f.ARRAY_BUFFER,g_quadVertexPositionBuffer);var b=f.getAttribLocation(f.program,"a_Position");f.vertexAttribPointer(b,3,f.FLOAT,false,0,0);f.enableVertexAttribArray(b);f.bindBuffer(f.ARRAY_BUFFER,g_quadVertexTexCoordBuffer);var k=f.getAttribLocation(f.program,"a_TexCoord");f.vertexAttribPointer(k,2,f.FLOAT,false,0,0);f.enableVertexAttribArray(k);f.activeTexture(f.TEXTURE0);f.bindTexture(f.TEXTURE_2D,TEXTURE);f.uniform1i(h,0);f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,IMAGE);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,g_quadVertexIndexBuffer);for(var e=0;e<a.length;++e){if(a[e].wait<=0){g_modelMatrix.setTranslate(a[e].position[0],a[e].position[1],a[e].position[2]);g_modelMatrix.rotate(a[e].angle,0,0,1);var d=0.5*a[e].scale;g_modelMatrix.scale(d,d,d);f.uniformMatrix4fv(c,false,g_modelMatrix.elements);f.uniform1f(g,a[e].alpha);f.drawElements(f.TRIANGLES,6,f.UNSIGNED_BYTE,0)}}}function updateParticle(b){for(var a=0;a<b.length;++a){if(b[a].wait>0){b[a].wait--;continue}b[a].position[0]+=b[a].velocity[0];b[a].position[1]+=b[a].velocity[1];b[a].position[2]+=b[a].velocity[2];b[a].velocity[1]-=0.003;b[a].alpha-=0.05;if(b[a].alpha<=0){initParticle(b[a],false)}}}function sendQuadVertexBuffers(c){var e=new Float32Array([-0.5,-0.5,0,0.5,-0.5,0,0.5,0.5,0,-0.5,0.5,0]);g_quadVertexPositionBuffer=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g_quadVertexPositionBuffer);c.bufferData(c.ARRAY_BUFFER,e,c.STATIC_DRAW);var a=new Float32Array([0,0,1,0,1,1,0,1]);g_quadVertexTexCoordBuffer=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g_quadVertexTexCoordBuffer);c.bufferData(c.ARRAY_BUFFER,a,c.STATIC_DRAW);var d=new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1]);g_quadVertexNormalBuffer=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,g_quadVertexNormalBuffer);c.bufferData(c.ARRAY_BUFFER,d,c.STATIC_DRAW);var b=new Uint8Array([0,1,2,2,3,0]);g_quadVertexIndexBuffer=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,g_quadVertexIndexBuffer);c.bufferData(c.ELEMENT_ARRAY_BUFFER,b,c.STATIC_DRAW);return true}function Particle(){this.velocity=new Array(3);this.position=new Array(3);this.angle=0;this.scale=0;this.alpha=0;this.wait=0}function initParticle(d,c){var e=Math.random()*Math.PI*2;var a=Math.random()*0.02+0.13;var b=Math.random()*0.01+0.02;d.velocity[0]=Math.cos(e)*b;d.velocity[1]=a;d.velocity[2]=Math.sin(e)*b;d.position[0]=Math.random()*0.2;d.position[1]=Math.random()*0.2;d.position[2]=Math.random()*0.2;d.angle=Math.random()*360;d.scale=Math.random()*0.5+0.5;d.alpha=5;if(c==true){d.wait=Math.random()*120}}function initTextures(b,a){TEXTURE=b.createTexture();if(!TEXTURE){console.log("テクスチャオブジェクトの作成に失敗");return false}IMAGE=new Image();if(!IMAGE){console.log("画像オブジェクトの作成に失敗");return false}IMAGE.onload=function(){loadTexture(b,TEXTURE,IMAGE)};IMAGE.src=a;return true}function loadTexture(c,a,b){c.bindTexture(c.TEXTURE_2D,a);c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,b);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR);c.bindTexture(c.TEXTURE_2D,null)};